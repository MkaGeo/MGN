<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Информация об объектах культурного наследия (ОКН)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .cookie-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .cookie-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            box-sizing: border-box;
        }
        .result-container {
            margin-top: 30px;
            display: none;
        }
        .result-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .result-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        .error-message {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success-message {
            color: #27ae60;
            background-color: #d5f4e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .info-item {
            margin-bottom: 10px;
        }
        .info-label {
            font-weight: bold;
            color: #34495e;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok {
            background-color: #27ae60;
        }
        .status-error {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Информация об объектах культурного наследия (ОКН)</h1>
        
        <div class="input-group">
            <label for="oknId">Идентификатор ОКН:</label>
            <input type="text" id="oknId" value="b8e6b14a-56f9-11e2-965f-005056806bb6">
        </div>
        
        <div class="cookie-section">
            <h3>Управление cookies</h3>
            <p>Для доступа к API необходимо использовать полную строку cookies. Вставьте ее ниже:</p>
            <textarea id="cookieInput" placeholder="Введите полную строку cookies в формате: name1=value1; name2=value2; ...">mos_id=Cg+IAmjbkG0pUlnGEdaTAgA=; _ym_uid=1743964869293872332; _ym_d=1759231760; session-cookie=186aa0acd33129bba05b710abeb261f5965b27f30a15d99da5951de9e099e674842d684ebe996e07168eff8329ab5af6; back_sid=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjgwMzBkYmJjLTkyNmYtNDg0Mi1hZmJlLTA0ZWM2NGJmYWVlZCIsInVzZXJuYW1lIjoicHVzY2hpbmF6diIsImlhdCI6MTc1OTM5NTI3MywiZXhwIjoxNzg4MTk1MjczLCJpc3MiOiJBSVMgTUdOIn0.lL1714myFg9IeM5aNqVmScD06l_YilVB1KeM-3tF7aE; sid=d75cbed4507890942cd83a479833a7a7e9900f1d6797cfb0faa656935685fd48; AuthSession=cHVzY2hpbmF6djo2OERFM0RDOTrd7ap6s6m7PwOcpuWVwI8LqRdvlQ</textarea>
            <div style="margin-top: 10px;">
                <button id="saveCookiesBtn">Сохранить cookies</button>
                <button id="checkCookiesBtn">Проверить cookies</button>
                <span id="cookieStatus" style="margin-left: 15px;"></span>
            </div>
        </div>
        
        <div>
            <button id="fetchDataBtn">Получить информацию об ОКН</button>
            <button id="clearBtn">Очистить результаты</button>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Загрузка данных...</p>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h2>Результаты запроса</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const oknIdInput = document.getElementById('oknId');
            const cookieInput = document.getElementById('cookieInput');
            const saveCookiesBtn = document.getElementById('saveCookiesBtn');
            const checkCookiesBtn = document.getElementById('checkCookiesBtn');
            const cookieStatus = document.getElementById('cookieStatus');
            const fetchDataBtn = document.getElementById('fetchDataBtn');
            const clearBtn = document.getElementById('clearBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            
            // Базовый URL API
            const API_BASE_URL = 'https://mgn.mos.ru/_api/postgres/grnkn/okn';
            
            // Загружаем сохраненные cookies при запуске
            const savedCookies = localStorage.getItem('oknCookies');
            if (savedCookies) {
                cookieInput.value = savedCookies;
                showCookieStatus('Cookies загружены из локального хранилища', 'success');
            }
            
            // Сохранение cookies
            saveCookiesBtn.addEventListener('click', function() {
                const cookies = cookieInput.value.trim();
                if (cookies) {
                    localStorage.setItem('oknCookies', cookies);
                    showCookieStatus('Cookies успешно сохранены!', 'success');
                } else {
                    showCookieStatus('Введите cookies!', 'error');
                }
            });
            
            // Проверка cookies
            checkCookiesBtn.addEventListener('click', function() {
                const cookies = localStorage.getItem('oknCookies');
                if (cookies) {
                    testCookies(cookies);
                } else {
                    showCookieStatus('Cookies не найдены! Сохраните cookies сначала.', 'error');
                }
            });
            
            // Получение данных об ОКН
            fetchDataBtn.addEventListener('click', function() {
                const oknId = oknIdInput.value.trim();
                const cookies = localStorage.getItem('oknCookies');
                
                if (!oknId) {
                    showResult('Введите идентификатор ОКН!', 'error');
                    return;
                }
                
                if (!cookies) {
                    showResult('Сначала сохраните cookies!', 'error');
                    return;
                }
                
                fetchOKNData(oknId, cookies);
            });
            
            // Очистка результатов
            clearBtn.addEventListener('click', function() {
                resultContainer.style.display = 'none';
                resultContent.innerHTML = '';
            });
            
            // Функция проверки cookies :cite[1]:cite[5]
            async function testCookies(cookies) {
                loadingIndicator.style.display = 'block';
                checkCookiesBtn.disabled = true;
                
                try {
                    const testUrl = `${API_BASE_URL}/b8e6b14a-56f9-11e2-965f-005056806bb6`;
                    
                    const response = await fetch(testUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cookie': cookies
                        },
                        credentials: 'include' // Важно для CORS с cookies :cite[8]
                    });
                    
                    if (response.ok) {
                        showCookieStatus('✓ Cookies работают корректно!', 'success');
                    } else if (response.status === 401) {
                        showCookieStatus('✗ Cookies недействительны или устарели!', 'error');
                    } else {
                        showCookieStatus(`Ошибка HTTP: ${response.status}`, 'error');
                    }
                } catch (error) {
                    if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                        showCookieStatus('✗ Ошибка CORS или сети. Проверьте подключение.', 'error');
                    } else {
                        showCookieStatus(`Ошибка: ${error.message}`, 'error');
                    }
                } finally {
                    loadingIndicator.style.display = 'none';
                    checkCookiesBtn.disabled = false;
                }
            }
            
            // Функция получения данных об ОКН :cite[1]:cite[8]
            async function fetchOKNData(oknId, cookies) {
                loadingIndicator.style.display = 'block';
                resultContainer.style.display = 'none';
                fetchDataBtn.disabled = true;
                
                try {
                    const url = `${API_BASE_URL}/${encodeURIComponent(oknId)}`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cookie': cookies,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include' // Ключевое исправление для CORS :cite[8]
                    });
                    
                    // Проверка статуса ответа :cite[1]
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('Неверные или устаревшие cookies. Пожалуйста, обновите cookies.');
                        } else if (response.status === 404) {
                            throw new Error('ОКН с указанным идентификатором не найден.');
                        } else {
                            throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
                        }
                    }
                    
                    const data = await response.json();
                    displayOKNData(data);
                    
                } catch (error) {
                    showResult(error.message, 'error');
                } finally {
                    loadingIndicator.style.display = 'none';
                    fetchDataBtn.disabled = false;
                }
            }
            
            // Функция отображения данных об ОКН
            function displayOKNData(data) {
                let html = '';
                
                // Основная информация
                html += `<div class="result-section">
                    <h3>Основная информация</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">ID:</span> ${data.id || 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Название:</span> ${data.title || 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Полное название:</span> ${data.fullTitle || 'Не указано'}
                        </div>
                        <div class="info-item full-width">
                            <span class="info-label">Адрес:</span> ${data.address || 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Статус охраны:</span> ${data.protectStatus ? data.protectStatus.title : 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Категория:</span> ${data.icvCategory ? data.icvCategory.title : 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Тип объекта:</span> ${data.type ? data.type.title : 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Вид недвижимости:</span> ${data.realtyType ? data.realtyType.title : 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Категория историко-культурного значения:</span> ${data.icv ? data.icv.title : 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">ЕГРОКН:</span> ${data.egrokn || 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Дата создания:</span> ${formatDate(data.createdAt) || 'Не указано'}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Дата обновления:</span> ${formatDate(data.updatedAt) || 'Не указано'}
                        </div>
                    </div>
                </div>`;
                
                // Датировка и атрибуция
                if (data.dating || data.authorship) {
                    html += `<div class="result-section">
                        <h3>Датировка и атрибуция</h3>
                        <div class="info-grid">
                            ${data.dating ? `<div class="info-item"><span class="info-label">Датировка:</span> ${data.dating}</div>` : ''}
                            ${data.authorship ? `<div class="info-item"><span class="info-label">Авторство:</span> ${data.authorship}</div>` : ''}
                        </div>
                    </div>`;
                }
                
                // Нормативные документы
                html += `<div class="result-section">
                    <h3>Нормативные документы</h3>
                    <div class="info-grid">
                        <div class="info-item full-width">
                            <span class="info-label">Основной документ:</span> ${data.baseDocumentTitle || 'Не указано'}
                        </div>
                        ${data.baseDocument ? `<div class="info-item full-width">
                            <span class="info-label">Детали документа:</span> ${data.baseDocument.title || 'Не указано'}
                        </div>` : ''}
                    </div>
                </div>`;
                
                // Историческая информация
                if (data.historicalInfo) {
                    html += `<div class="result-section">
                        <h3>Историческая справка</h3>
                        <div class="info-item full-width">
                            ${formatText(data.historicalInfo)}
                        </div>
                    </div>`;
                }
                
                // Описание предмета охраны
                if (data.protectionDescription) {
                    html += `<div class="result-section">
                        <h3>Описание предмета охраны</h3>
                        <div class="info-item full-width">
                            ${formatText(data.protectionDescription)}
                        </div>
                    </div>`;
                }
                
                // Дополнительная информация
                if (data.qualifyingInfo || data.generalInfo) {
                    html += `<div class="result-section">
                        <h3>Дополнительная информация</h3>
                        <div class="info-grid">
                            ${data.qualifyingInfo ? `<div class="info-item full-width">
                                <span class="info-label">Квалификационная информация:</span> ${data.qualifyingInfo}
                            </div>` : ''}
                            ${data.generalInfo ? `<div class="info-item full-width">
                                <span class="info-label">Общая информация:</span> ${formatText(data.generalInfo)}
                            </div>` : ''}
                        </div>
                    </div>`;
                }
                
                // Состав объекта (недвижимости)
                if (data.realties && data.realties.length > 0) {
                    html += `<div class="result-section">
                        <h3>Состав объекта (здания и сооружения)</h3>
                        <div class="info-grid">`;
                    
                    data.realties.forEach(realty => {
                        html += `<div class="info-item full-width">
                            <span class="info-label">Объект недвижимости:</span> ${realty.title || 'Не указано'}
                        </div>`;
                    });
                    
                    html += `</div></div>`;
                }
                
                resultContent.innerHTML = html;
                resultContainer.style.display = 'block';
            }
            
            // Вспомогательная функция для форматирования текста
            function formatText(text) {
                if (!text) return '';
                return text.replace(/\n/g, '<br>');
            }
            
            // Вспомогательная функция для форматирования даты
            function formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ru-RU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            }
            
            // Функция отображения статуса cookies
            function showCookieStatus(message, type) {
                const statusIndicator = type === 'success' ? 
                    '<span class="status-indicator status-ok"></span>' : 
                    '<span class="status-indicator status-error"></span>';
                
                cookieStatus.innerHTML = statusIndicator + message;
                cookieStatus.style.color = type === 'success' ? '#27ae60' : '#e74c3c';
                cookieStatus.style.fontWeight = 'bold';
                
                // Автоматическое скрытие сообщения через 5 секунд
                setTimeout(() => {
                    cookieStatus.innerHTML = '';
                }, 5000);
            }
            
            // Функция отображения результата (ошибки)
            function showResult(message, type) {
                const icon = type === 'error' ? '✗' : '✓';
                resultContent.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${icon} ${message}</div>`;
                resultContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>